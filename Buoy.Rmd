---
title: "Buoy Project"
author: "Jason Huang"
date: "2020/9/25"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load("knitr","ggplot2","rstanarm","tidyverse","lubridate","zoo","astsa")
```


#Abstract
This report seeks to use 20-years of data NDBC Station 44013 to analyze climate change problem.

#Data Collection
Data was abstracted from NDBC website. 30-years of data was collected from 1987 to 2016. Six variables were selected namely, year(YY), month(MM), day(DD), hour(hh), air temperature(ATMP) and sea surface temperature(WTMP). In order to see how the trend of temperature change, the only two related variables ATMP and WTMP were selected.
```{r echo = FALSE}
### make URLs

url1 <- "http://www.ndbc.noaa.gov/view_text_file.php?filename=mlrf1h"
url2 <- ".txt.gz&dir=data/historical/stdmet/"

years <- c(1987:2016)

urls <- str_c(url1, years, url2, sep = "")

filenames <- str_c("ma", years, sep = "")

###  Read the data from the website

N <- length(urls)

for (i in 1:N){
  suppressMessages( ###  This stops the annoying messages on your screen.  Do this last.
    assign(filenames[i], read_table(urls[i], col_names = TRUE))
  )
  
  file <- get(filenames[i])
  
  x <- ncol(file)

  
#Since data from different year has different columns, we seperate them and only take the columns we want  
  if(x %in% c(15,16)){
      colnames(file)[1] <-"YYYY"
      colnames(file)[2] <-"MM"
      colnames(file)[3] <-"DD"
      colnames(file)[4] <-"hh"
      colnames(file)[12] <-"Air_tmp"
      colnames(file)[13] <-"Water_tmp"
      file <- file[,c(1,2,3,4,12,13)]
  }
  if(x==17){
      colnames(file)[1] <-"YYYY"
      colnames(file)[2] <-"MM"
      colnames(file)[3] <-"DD"
      colnames(file)[4] <-"hh"
      colnames(file)[13] <-"Air_tmp"
      colnames(file)[14] <-"Water_tmp"
      file <- file[,c(1,2,3,4,13,14)]
  }

#Combine all dataframes
  if(i == 1){
    MR <- file
  }

  else{
    MR <- rbind.data.frame(MR, file)
  }
}
```

#Data Cleaning
Variable ATMP and WTMP were converted to $double$ and a new variable 'YYYY_MM_DD' was added to the dataset. The new variable is $date$ type. Data with temperature higher than 90â„ƒ were deleted. Average daily temperature was first calculated by taking the mean of 24 hours temperature. Then, average monthly temperature was calculated by taking the mean of average daily temperature per month. The reason why temperature were calculated in this way was that all data was taken into consideration. 
```{r echo = FALSE}
MR_2 <- as_tibble(MR)
#Change type of Air_tmp and Water_tmp from chr to dbl
MR_2 <- MR_2 %>%
  mutate(Air_tmp = as.double(Air_tmp),
         Water_tmp = as.double(Water_tmp),
         YYYY_MM_DD = ymd(paste(YYYY,MM,DD,sep = "-"))) %>%
  relocate(YYYY_MM_DD)

#Get rid of tittle line
MR_2 <- filter(MR_2,hh != "hr")

#Get rid of abnormal data
MR_2 <- filter(MR_2,Air_tmp < 99, Water_tmp < 99)

#Get daily average Tmp
MR_3_1 <- select(MR_2,-c(2,3,4,7)) %>%
  group_by(YYYY_MM_DD) %>%
  summarize(Avg_Air_tmp = mean(Air_tmp))

MR_3_2 <- select(MR_2,-c(2,3,4,6)) %>%
  group_by(YYYY_MM_DD) %>%
  summarize(Avg_Water_tmp = mean(Water_tmp))

#Get monthly average Tmp
MR_4_1 <- MR_3_1 %>%
  group_by(month = floor_date(YYYY_MM_DD,"month")) %>%
  summarize(Avg_Air_tmp = mean(Avg_Air_tmp))

MR_4_2 <- MR_3_2 %>%
  group_by(month = floor_date(YYYY_MM_DD,"month")) %>%
  summarize(Avg_Water_tmp = mean(Avg_Water_tmp))

MR_4 <- inner_join(MR_4_1,MR_4_2)


#Export data
write_csv(MR_4,"MR_data_1987_2016.csv")
```

#Model Fitting
Data was first plotted to see if any model could be considered. Time series model was considered given the shape of the plot. Also, linear regression model was considered since it was a very simple model and the sign of the slope can be used to check the trend of climate change.
```{r echo = FALSE}
#Plot data
#Average Tmp
MR_4 %>%
  ggplot(aes(x = month,y = Avg_Air_tmp)) + 
  geom_line() +
  geom_point()

MR_4 %>%
  ggplot(aes(x = month,y = Avg_Water_tmp)) + 
  geom_line() +
  geom_point()
```

##Time Series Model
Given it was a seasonal data, seasonal ARIMA model was considered. The trend of data within a year was check. After setting the seasonal period $s$ to be 12, ACF and PACF were plotted. By checking the plot, model $ARIMA (1,0,0) \times (0,1,1)_{12}$ was considered. The predicted data in the next 20 years was plotted. From this model, conclusion about global warming can't be drawn. No strong sign of rise or drop in temperature was shown from model. However, a weak sign of drop in both air and sea surface temperature was shown in the predicted data plot.
```{r echo = FALSE}
#Check the trend within a year
MR_1988 <- filter(MR_4,year(month)==1988)
MR_1988 %>%
  ggplot(aes(x = month, y = Avg_Air_tmp)) +
  geom_line() +
  geom_point()

#create TS
TS_MR_4_1 <- ts(select(MR_4_1,Avg_Air_tmp))

#check trend
plot(TS_MR_4_1,type="b")

#set seasonal index
diff12 = diff(TS_MR_4_1,12)
plot(diff12,type="b")

#check acf pacf
acf2(diff12,48)

#fit model
sarima(TS_MR_4_1,1,0,0,0,1,1,12,details = FALSE,Model = FALSE)

#predict
sarima.for(TS_MR_4_1,240,1,0,0,0,1,1,12)

#create TS
TS_MR_4_2 <- ts(select(MR_4_2,Avg_Water_tmp))

#check trend
plot(TS_MR_4_2,type="b")

#set seasonal index
diff12 = diff(TS_MR_4_2,12)
plot(diff12,type="b")

#check acf pacf
acf2(diff12,48)

#fit model
sarima(TS_MR_4_2,1,0,0,0,1,1,12,details = FALSE,Model = FALSE)

#predict
sarima.for(TS_MR_4_2,240,1,0,0,0,1,1,12)
```

##Linear Regression Model
For linear regression model, data was divided into 12 month. Data for each month was fitted to a linear regression model. All fitted lines and data were plotted in the same page. Red color indicated the upward trend and blue color indicated the downward trend. For air temperatue, fitted lines from May to August have positive slope. For sea surface temperature, fitted lines from May to June and August have positive slope. It is likely that temperature in hot seasons like summer is increasing while decreasing in other seasons.
```{r echo = FALSE}
#Red indicates an upward trend
#Blue indicates an downward trend

#plot air_tmp average
par(mfrow=c(3,4))
for(i in 1:12){
  LM_MR_4_1 <- filter(MR_4_1,month(month)==i)
  LM_1 <- lm(Avg_Air_tmp~month,data = LM_MR_4_1)

  if(coef(LM_1)[2]>0){
    plot(x = LM_MR_4_1$month, y =  LM_MR_4_1$Avg_Air_tmp,xlab = "month", ylab = "Air_tmp",main = paste("month",i,sep = "_"))
    abline(coef(LM_1)[1],coef(LM_1)[2], col="RED")
  
  }
  
  if(coef(LM_1)[2]<0){
    plot(x = LM_MR_4_1$month, y =  LM_MR_4_1$Avg_Air_tmp,xlab = "month", ylab = "Air_tmp",main = paste("month",i,sep = "_"))
    abline(coef(LM_1)[1],coef(LM_1)[2], col="BLUE")
  
  }
}

#plot water_tmp
par(mfrow=c(3,4))
for(i in 1:12){
  LM_MR_4_2 <- filter(MR_4_2,month(month)==i)
  LM_2 <- lm(Avg_Water_tmp~month,data = LM_MR_4_2)

  if(coef(LM_2)[2]>0){
    plot(x = LM_MR_4_2$month, y =  LM_MR_4_2$Avg_Water_tmp,xlab = "month", ylab = "Water_tmp",main = paste("month",i,sep = "_"))
    abline(coef(LM_2)[1],coef(LM_2)[2], col="RED")
  
  }
  
  if(coef(LM_2)[2]<0){
    plot(x = LM_MR_4_2$month, y =  LM_MR_4_2$Avg_Water_tmp,xlab = "month", ylab = "Water_tmp",main = paste("month",i,sep = "_"))
    abline(coef(LM_2)[1],coef(LM_2)[2], col="BLUE")
  
  }
}


```
#Conclusion
Two models just offer us a direction about climate change. Firm conclusion about climate change can not be drawn. But still, some useful information was shown from the data and models. From time series model, a predicted dropping trend of temperature was shown. For linear regression model, a rising trend of temperature in summer was shown. Conjecture could be made. A possible reason could be that global warming is casuing summer to be hotter while the melting of glaciers is casuing winter to be colder.
```{r}
filter(MR_2,YYYY==16)
?acf2
```

